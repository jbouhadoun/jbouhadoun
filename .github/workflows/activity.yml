name: Update Profile
on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Get contributions and activity
        id: activity
        run: |
          # RÃ©cupÃ©rer les langages principaux
          languages=$(curl -s "https://api.github.com/users/jbouhadoun/repos" | \
            jq -r '.[].language | select(. != null)' | \
            sort | uniq -c | sort -rn | head -6 | awk '{print $2}')
          
          # RÃ©cupÃ©rer les repos avec activitÃ© rÃ©cente
          recent_repos=$(curl -s "https://api.github.com/users/jbouhadoun/repos?sort=updated&per_page=5" | \
            jq -r '.[] | select(.updated_at > (now - 30*24*3600 | strftime("%Y-%m-%dT%H:%M:%SZ"))) | 
            "[\(.name)](\(.html_url)) - \(.description // "Projet en cours")"')
          
          # RÃ©cupÃ©rer les derniÃ¨res pull requests
          recent_prs=$(curl -s "https://api.github.com/search/issues?q=author:jbouhadoun+type:pr+is:merged&sort=updated&per_page=4" | \
            jq -r '.items[] | "- **\(.repository_url | split("/")[-1])**: \(.title | .[0:60])\(if (.title | length) > 60 then "..." else "" end)"')
          
          # DÃ©tection frameworks depuis repos actifs
          frameworks=""
          active_repos=$(curl -s "https://api.github.com/users/jbouhadoun/repos?sort=updated&per_page=10" | jq -r '.[].name')
          
          for repo in $active_repos; do
            package_json=$(curl -s "https://api.github.com/repos/jbouhadoun/$repo/contents/package.json" 2>/dev/null)
            if echo "$package_json" | jq -e '.content' > /dev/null 2>&1; then
              content=$(echo "$package_json" | jq -r '.content' | base64 -d 2>/dev/null)
              if [ $? -eq 0 ]; then
                deps=$(echo "$content" | jq -r '.dependencies // {}, .devDependencies // {} | keys[]' 2>/dev/null)
                echo "$deps" | while read dep; do
                  case "$dep" in
                    "react") echo "React" ;;
                    "next") echo "Next.js" ;;
                    "vue") echo "Vue.js" ;;
                    "express") echo "Express.js" ;;
                    "@nestjs/core") echo "NestJS" ;;
                    "fastify") echo "Fastify" ;;
                  esac
                done
              fi
            fi
          done | sort | uniq > frameworks_temp.txt
          
          frameworks=$(cat frameworks_temp.txt | tr '\n' ' ')
          
          # CrÃ©er badges pour langages + frameworks dÃ©tectÃ©s
          all_tech="$languages $frameworks"
          tech_badges=""
          for tech in $all_tech; do
            case $tech in
              "JavaScript") tech_badges="$tech_badges![JavaScript](https://img.shields.io/badge/JavaScript-F7DF1E?style=flat&logo=javascript&logoColor=black) " ;;
              "TypeScript") tech_badges="$tech_badges![TypeScript](https://img.shields.io/badge/TypeScript-007ACC?style=flat&logo=typescript&logoColor=white) " ;;
              "Python") tech_badges="$tech_badges![Python](https://img.shields.io/badge/Python-3776AB?style=flat&logo=python&logoColor=white) " ;;
              "Java") tech_badges="$tech_badges![Java](https://img.shields.io/badge/Java-ED8B00?style=flat&logo=java&logoColor=white) " ;;
              "React") tech_badges="$tech_badges![React](https://img.shields.io/badge/React-61DAFB?style=flat&logo=react&logoColor=black) " ;;
              "Next.js") tech_badges="$tech_badges![Next.js](https://img.shields.io/badge/Next.js-000000?style=flat&logo=nextdotjs&logoColor=white) " ;;
              "Vue.js") tech_badges="$tech_badges![Vue.js](https://img.shields.io/badge/Vue.js-4FC08D?style=flat&logo=vue.js&logoColor=white) " ;;
              "Express.js") tech_badges="$tech_badges![Express](https://img.shields.io/badge/Express-000000?style=flat&logo=express&logoColor=white) " ;;
              "NestJS") tech_badges="$tech_badges![NestJS](https://img.shields.io/badge/NestJS-E0234E?style=flat&logo=nestjs&logoColor=white) " ;;
              "C++") tech_badges="$tech_badges![C++](https://img.shields.io/badge/C++-00599C?style=flat&logo=cplusplus&logoColor=white) " ;;
              "PHP") tech_badges="$tech_badges![PHP](https://img.shields.io/badge/PHP-777BB4?style=flat&logo=php&logoColor=white) " ;;
              "Go") tech_badges="$tech_badges![Go](https://img.shields.io/badge/Go-00ADD8?style=flat&logo=go&logoColor=white) " ;;
              *) tech_badges="$tech_badges![${tech}](https://img.shields.io/badge/${tech}-grey?style=flat) " ;;
            esac
          done
          
          rm -f frameworks_temp.txt
          
          echo "TECH_BADGES=$tech_badges" >> $GITHUB_OUTPUT
          echo "RECENT_REPOS<<EOF" >> $GITHUB_OUTPUT
          echo "$recent_repos" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "RECENT_PRS<<EOF" >> $GITHUB_OUTPUT
          echo "$recent_prs" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update README
        run: |
          cat > README.md << 'EOF'
          # Hey ! ðŸ‘‹
          
          PassionnÃ© de tech, je dÃ©veloppe des projets qui ont du sens.
          
          ## Stack technique
          ${{ steps.activity.outputs.TECH_BADGES }}
          
          ## Statistiques
          <div>
            <img height="180em" src="https://github-readme-stats.vercel.app/api?username=jbouhadoun&show_icons=true&theme=default&include_all_commits=true"/>
            <img height="180em" src="https://github-readme-stats.vercel.app/api/top-langs/?username=jbouhadoun&layout=compact&theme=default"/>
          </div>
          
          ## Projets rÃ©cents
          ${{ steps.activity.outputs.RECENT_REPOS }}
          
          ## DerniÃ¨res contributions
          ${{ steps.activity.outputs.RECENT_PRS }}
          
          ## Contact
          - ðŸ“§ [Email](jbouahdoun@gmail.com)          
          ---
          <sub>Mis Ã  jour automatiquement</sub>
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git diff --staged --quiet || git commit -m "ðŸ“Š Update profile stats"
          git push
