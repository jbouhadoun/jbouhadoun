name: Update Profile
on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Get recent activity
        id: activity
        run: |
          # RÃ©cupÃ©rer les langages
          languages=$(curl -s "https://api.github.com/users/jbouhadoun/repos" | \
            jq -r '.[].language | select(. != null)' | \
            sort | uniq -c | sort -rn | head -5 | awk '{print $2}')
          
          # RÃ©cupÃ©rer les derniers commits
          recent_commits=$(curl -s "https://api.github.com/users/jbouhadoun/events" | \
            jq -r '.[] | select(.type == "PushEvent") | .repo.name' | head -3 | sort -u)
          
          # RÃ©cupÃ©rer les derniÃ¨res pull requests
          recent_prs=$(curl -s "https://api.github.com/search/issues?q=author:jbouhadoun+type:pr&sort=updated&per_page=3" | \
            jq -r '.items[] | "\(.repository_url | split("/")[-1]): \(.title)"')
          
          # CrÃ©er des badges simples pour les langages
          lang_badges=""
          for lang in $languages; do
            case $lang in
              "JavaScript") lang_badges="$lang_badges ![JS](https://img.shields.io/badge/-JavaScript-yellow)" ;;
              "TypeScript") lang_badges="$lang_badges ![TS](https://img.shields.io/badge/-TypeScript-blue)" ;;
              "Python") lang_badges="$lang_badges ![Python](https://img.shields.io/badge/-Python-green)" ;;
              "Java") lang_badges="$lang_badges ![Java](https://img.shields.io/badge/-Java-orange)" ;;
              "React") lang_badges="$lang_badges ![React](https://img.shields.io/badge/-React-blue)" ;;
              *) lang_badges="$lang_badges ![${lang}](https://img.shields.io/badge/-${lang}-lightgrey)" ;;
            esac
          done
          
          echo "LANG_BADGES=$lang_badges" >> $GITHUB_OUTPUT
          echo "RECENT_COMMITS<<EOF" >> $GITHUB_OUTPUT
          echo "$recent_commits" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "RECENT_PRS<<EOF" >> $GITHUB_OUTPUT
          echo "$recent_prs" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update README
        run: |
          cat > README.md << 'EOF'
          # Salut ðŸ‘‹
          
          Je suis Jugurtha
          
          ## Ce que j'utilise actuellement
          ${{ steps.activity.outputs.LANG_BADGES }}
          
          ## Mes stats
          ![Stats](https://github-readme-stats.vercel.app/api?username=jbouhadoun&show_icons=true&theme=default)
          
          ## DerniÃ¨re activitÃ©
          
          **Repos rÃ©cents:**
          ${{ steps.activity.outputs.RECENT_COMMITS }}
          
          **DerniÃ¨res PRs:**
          ${{ steps.activity.outputs.RECENT_PRS }}
          
          ## Contact
          - ðŸ“§ [Email](mailto:votre.email@example.com)
          - ðŸ’¼ [LinkedIn](https://linkedin.com/in/votre-profil)
          
          ---
          *DerniÃ¨re mise Ã  jour automatique*
          EOF

      - name: Commit
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git diff --staged --quiet || git commit -m "Update profile"
          git push
